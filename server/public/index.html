<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTA Race Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --color-bg-light: #f8fafc;
            --color-bg-black: #000;
            --color-card-light: #fff;
            --color-card-black: #111;
            --color-text-light: #232946;
            --color-text-black: #fff;
            --color-accent: #2563eb;
            --color-muted: #e5e7eb;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--color-bg-light);
            color: var(--color-text-light);
            min-height: 100vh;
            transition: background 0.3s, color 0.3s;
        }
        body.theme-black {
            background: var(--color-bg-black);
            color: var(--color-text-black);
        }
        nav {
            background: var(--color-card-light);
            color: var(--color-text-light);
            box-shadow: 0 2px 8px 0 rgba(0,0,0,0.04);
            transition: background 0.3s, color 0.3s;
        }
        body.theme-black nav {
            background: var(--color-card-black);
            color: var(--color-text-black);
        }
        .minimal-card {
            background: var(--color-card-light) !important;
            color: var(--color-text-light) !important;
            border-radius: 1rem;
            box-shadow: 0 2px 8px 0 rgba(0,0,0,0.04);
            border: 1px solid var(--color-muted);
            transition: background 0.3s, color 0.3s;
        }
        body.theme-black .minimal-card {
            background: var(--color-card-black) !important;
            color: var(--color-text-black) !important;
            border: 1px solid #222;
        }
        .job-card {
            background: var(--color-card-light);
            color: var(--color-text-light);
            border-radius: 1rem;
            box-shadow: 0 2px 8px 0 rgba(0,0,0,0.04);
            border: 1px solid var(--color-muted);
            transition: background 0.3s, color 0.3s;
        }
        body.theme-black .job-card {
            background: var(--color-card-black);
            color: var(--color-text-black);
            border: 1px solid #222;
        }
        .job-card:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 4px 16px 0 rgba(0,0,0,0.08);
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .btn {
            background: var(--color-accent);
            color: #fff;
            border-radius: 0.5rem;
            padding: 0.5rem 1.25rem;
            font-weight: 600;
            box-shadow: 0 1px 4px 0 rgba(0,0,0,0.04);
            transition: background 0.2s, color 0.2s;
        }
        .btn:hover {
            background: #1d4ed8;
        }
        .label {
            color: var(--color-text-light);
            font-weight: 500;
        }
        body.theme-black .label {
            color: var(--color-text-black);
        }
        .input {
            background: var(--color-card-light);
            color: var(--color-text-light);
            border: 1px solid var(--color-muted);
            border-radius: 0.375rem;
            padding: 0.5rem;
            transition: background 0.2s, color 0.2s, border 0.2s;
        }
        body.theme-black .input {
            background: var(--color-card-black);
            color: var(--color-text-black);
            border: 1px solid #222;
        }
        .section-title {
            color: var(--color-text-light);
            font-weight: 700;
        }
        body.theme-black .section-title {
            color: var(--color-text-black);
        }
        .text-muted {
            color: var(--color-muted);
        }
        body.theme-black .text-muted {
            color: #888;
        }
        .minimal-btn {
            background: var(--color-accent);
            color: #fff;
            border-radius: 0.5rem;
            padding: 0.5rem 1.25rem;
            font-weight: 600;
            box-shadow: 0 1px 4px 0 rgba(0,0,0,0.04);
            transition: background 0.2s, color 0.2s;
        }
        .minimal-btn:hover {
            background: #1d4ed8;
        }
        .minimal-btn.active, .minimal-btn:active {
            background: var(--color-accent) !important;
            color: #fff !important;
            box-shadow: 0 2px 8px 0 rgba(37,99,235,0.08);
            font-weight: 700;
        }
        .dark-toggle {
            background: none;
            border: none;
            color: var(--color-accent);
            font-size: 1.3rem;
            margin-left: 1rem;
            cursor: pointer;
            transition: color 0.2s;
        }
        .dark-toggle:hover {
            color: #111;
        }
        footer {
            background: var(--color-card-light);
            color: var(--color-text-light);
            text-align: center;
            padding: 1.5rem 0 0.5rem 0;
            font-size: 1rem;
            opacity: 0.95;
            margin-top: 2rem;
            border-top-left-radius: 2rem;
            border-top-right-radius: 2rem;
            transition: background 0.3s, color 0.3s;
        }
        body.theme-black footer {
            background: var(--color-card-black);
            color: var(--color-text-black);
        }
        .stats-table thead tr {
            background: var(--color-card-light);
            color: var(--color-text-light);
            border-bottom: 2px solid var(--color-muted);
            font-size: 0.75rem;
        }
        body.theme-black .stats-table thead tr {
            background: var(--color-card-black);
            color: var(--color-text-black);
            border-bottom: 2px solid #222;
        }
        .stats-table tbody tr {
            background: var(--color-card-light);
            font-size: 0.75rem;
        }
        body.theme-black .stats-table tbody tr {
            background: var(--color-card-black);
        }
        .stats-table th, .stats-table td {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        .stats-table input[type='number'],
        .stats-table input[type='text'] {
            background: var(--color-card-light);
            color: var(--color-text-light);
            border: 1px solid var(--color-muted);
            font-size: 0.75rem;
            padding: 0.125rem 0.25rem;
            height: 1.5rem;
            width: auto;
        }
        body.theme-black .stats-table input[type='number'],
        body.theme-black .stats-table input[type='text'] {
            background: var(--color-card-black);
            color: var(--color-text-black);
            border: 1px solid #222;
        }
        .stats-table input[type='checkbox'] {
            width: 1rem;
            height: 1rem;
        }
        .modal-title {
            color: var(--color-text-light);
        }
        body.theme-black .modal-title {
            color: var(--color-text-black);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <nav class="p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-extrabold flex items-center tracking-tight">
                <i class="fas fa-car-side mr-2 text-accent"></i>
                GTA Race Tracker
            </h1>
            <div class="space-x-4 flex items-center">
                <button id="showJobs" class="minimal-btn"><i class="fas fa-list mr-2"></i>Jobs</button>
                <button id="showPlaylists" class="minimal-btn"><i class="fas fa-music mr-2"></i>Playlists</button>
                <div id="userSection" class="inline-block"></div>
                <button id="themeToggle" class="dark-toggle" title="Toggle theme"><i class="fas fa-circle-half-stroke"></i></button>
            </div>
        </div>
    </nav>
    <main class="container mx-auto p-4 flex-1">
        <!-- Jobs Section -->
        <section id="jobsSection" class="space-y-4 fade-in">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Saved Jobs</h2>
                <div class="flex space-x-2">
                    <button id="refreshJobs" class="minimal-btn"><i class="fas fa-sync-alt mr-2"></i>Refresh</button>
                </div>
            </div>
            <div id="jobsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Jobs will be inserted here -->
            </div>
        </section>
        <!-- Playlists Section -->
        <section id="playlistsSection" class="hidden space-y-4 fade-in">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Playlists</h2>
                <button id="createPlaylist" class="minimal-btn"><i class="fas fa-plus mr-2"></i>Create New Playlist</button>
            </div>
            <div id="playlistsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Playlists will be inserted here -->
            </div>
        </section>
        <!-- Playlist Details Section -->
        <section id="playlistDetailsSection" class="hidden space-y-4 fade-in">
            <div class="flex items-center mb-4">
                <button id="backToPlaylists" class="minimal-btn mr-4"><i class="fas fa-arrow-left mr-2"></i>Back</button>
                <h2 id="playlistDetailsTitle" class="text-2xl font-bold"></h2>
            </div>
            <div class="minimal-card p-4">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <p id="playlistStats" class="font-semibold"></p>
                        <p id="playlistDates" class="text-sm"></p>
                    </div>
                    <div class="flex space-x-2">
                        <button id="addJobsToPlaylist" class="minimal-btn"><i class="fas fa-plus mr-2"></i>Add Jobs</button>
                        <button id="managePlayersBtn" class="minimal-btn"><i class="fas fa-users mr-2"></i>Manage Players</button>
                    </div>
                </div>
                <div id="playlistJobs" class="space-y-4">
                    <!-- Playlist jobs will be inserted here -->
                </div>
            </div>
        </section>
    </main>
    <footer>
        <div class="container mx-auto">
            <span>&copy; <span id="yearSpan"></span> GTA Race Tracker &mdash; All rights reserved.</span>
        </div>
    </footer>
    <!-- Create Playlist Modal -->
    <div id="createPlaylistModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="minimal-card p-6 w-96 shadow-xl">
            <h3 class="modal-title section-title text-2xl mb-4">Create New Playlist</h3>
            <input type="text" id="playlistName" placeholder="Playlist Name" class="input w-full mb-4">
            <div class="flex justify-end space-x-2">
                <button id="cancelCreate" class="btn bg-gray-300">Cancel</button>
                <button id="confirmCreate" class="btn">Create</button>
            </div>
        </div>
    </div>
    <!-- Add Jobs to Playlist Modal -->
    <div id="addJobsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="minimal-card p-6 w-3/4 max-h-[80vh] shadow-xl overflow-hidden flex flex-col">
            <h3 class="section-title text-xl mb-4">Add Jobs to Playlist</h3>
            <div class="flex-1 overflow-y-auto mb-4">
                <div id="availableJobs" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Available jobs will be inserted here -->
                </div>
            </div>
            <div class="flex justify-end space-x-2">
                <button id="cancelAddJobs" class="btn bg-gray-300">Cancel</button>
                <button id="confirmAddJobs" class="btn">Add Selected Jobs</button>
            </div>
        </div>
    </div>
    <!-- Edit Playlist Modal -->
    <div id="editPlaylistModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="minimal-card p-6 w-96 shadow-xl">
            <h3 class="modal-title section-title text-2xl mb-4">Edit Playlist</h3>
            <input type="text" id="editPlaylistName" placeholder="Playlist Name" class="input w-full mb-4">
            <div class="flex justify-end space-x-2">
                <button id="cancelEdit" class="btn bg-gray-300">Cancel</button>
                <button id="confirmEdit" class="btn">Save Changes</button>
            </div>
        </div>
    </div>
    <!-- User Selection Modal -->
    <div id="userSelectModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="minimal-card p-6 w-96 shadow-xl">
            <h3 class="text-xl font-bold mb-4">Select User</h3>
            <form id="userSelectForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">User</label>
                    <select id="userDropdown" class="mt-1 w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></select>
                </div>
                <div id="newUserSection" class="hidden">
                    <label class="block text-sm font-medium text-gray-700">New Username</label>
                    <input type="text" id="newUsername" class="mt-1 w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancelUserSelect" 
                            class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 transition-colors">Cancel</button>
                    <button type="submit" 
                            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                        Select
                    </button>
                </div>
            </form>
        </div>
    </div>
    <!-- Manage Players Modal -->
    <div id="managePlayersModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="minimal-card p-6 w-96 shadow-xl">
            <h3 class="section-title text-xl mb-4">Manage Players</h3>
            <form id="managePlayersForm" class="space-y-2 mb-4">
                <div id="playersCheckboxList"></div>
            </form>
            <div class="flex justify-end space-x-2">
                <button id="cancelManagePlayers" class="btn bg-gray-300">Cancel</button>
                <button id="saveManagePlayers" class="btn">Save</button>
            </div>
        </div>
    </div>
    <script>
    window.addEventListener('DOMContentLoaded', function() {
        const API_URL = 'https://trackers.studio/api';
        let currentPlaylistId = null;
        let selectedJobs = new Map();
        let currentUser = null;
        let currentPlaylistPlayers = [];
        
        // UI Elements
        const jobsSection = document.getElementById('jobsSection');
        const playlistsSection = document.getElementById('playlistsSection');
        const playlistDetailsSection = document.getElementById('playlistDetailsSection');
        const showJobsBtn = document.getElementById('showJobs');
        const showPlaylistsBtn = document.getElementById('showPlaylists');
        const createPlaylistBtn = document.getElementById('createPlaylist');
        const createPlaylistModal = document.getElementById('createPlaylistModal');
        const cancelCreateBtn = document.getElementById('cancelCreate');
        const confirmCreateBtn = document.getElementById('confirmCreate');
        const playlistNameInput = document.getElementById('playlistName');
        const backToPlaylistsBtn = document.getElementById('backToPlaylists');
        const addJobsToPlaylistBtn = document.getElementById('addJobsToPlaylist');
        const addJobsModal = document.getElementById('addJobsModal');
        const cancelAddJobsBtn = document.getElementById('cancelAddJobs');
        const confirmAddJobsBtn = document.getElementById('confirmAddJobs');
        const refreshJobsBtn = document.getElementById('refreshJobs');
        const editPlaylistModal = document.getElementById('editPlaylistModal');
        const cancelEditBtn = document.getElementById('cancelEdit');
        const confirmEditBtn = document.getElementById('confirmEdit');
        const editPlaylistNameInput = document.getElementById('editPlaylistName');
        const userSelectModal = document.getElementById('userSelectModal');
        const showUserSelectBtn = document.getElementById('showUserSelect');
        const cancelUserSelectBtn = document.getElementById('cancelUserSelect');
        const userSelectForm = document.getElementById('userSelectForm');
        const userSection = document.getElementById('userSection');
        const managePlayersModal = document.getElementById('managePlayersModal');
        const managePlayersBtn = document.getElementById('managePlayersBtn');
        const cancelManagePlayersBtn = document.getElementById('cancelManagePlayers');
        const saveManagePlayersBtn = document.getElementById('saveManagePlayers');
        const playersCheckboxList = document.getElementById('playersCheckboxList');
        const managePlayersForm = document.getElementById('managePlayersForm');

        // Theme toggle logic
        const themeOrder = ['theme-light', 'theme-black'];
        let themeIdx = 0;
        const body = document.body;
        const themeToggle = document.getElementById('themeToggle');
        function setTheme(idx) {
            themeOrder.forEach(cls => body.classList.remove(cls));
            body.classList.add(themeOrder[idx]);
            themeIdx = idx;
            localStorage.setItem('gtaTheme', themeOrder[idx]);
        }
        // Load theme from storage
        const savedTheme = localStorage.getItem('gtaTheme');
        if (savedTheme && themeOrder.includes(savedTheme)) {
            setTheme(themeOrder.indexOf(savedTheme));
        } else {
            setTheme(0);
        }
        themeToggle.addEventListener('click', () => {
            setTheme((themeIdx + 1) % themeOrder.length);
        });
        // Set year in footer
        document.getElementById('yearSpan').textContent = new Date().getFullYear();

        // Navigation
        function setActiveNav(section) {
            if (showJobsBtn) showJobsBtn.classList.remove('active');
            if (showPlaylistsBtn) showPlaylistsBtn.classList.remove('active');
            if (section === 'jobs' && showJobsBtn) showJobsBtn.classList.add('active');
            if (section === 'playlists' && showPlaylistsBtn) showPlaylistsBtn.classList.add('active');
        }
        if (showJobsBtn) showJobsBtn.addEventListener('click', () => {
            jobsSection.classList.remove('hidden');
            playlistsSection.classList.add('hidden');
            playlistDetailsSection.classList.add('hidden');
            loadJobs();
            setActiveNav('jobs');
        });
        if (showPlaylistsBtn) showPlaylistsBtn.addEventListener('click', () => {
            jobsSection.classList.add('hidden');
            playlistsSection.classList.remove('hidden');
            playlistDetailsSection.classList.add('hidden');
            loadPlaylists();
            setActiveNav('playlists');
        });
        if (backToPlaylistsBtn) backToPlaylistsBtn.addEventListener('click', () => {
            playlistDetailsSection.classList.add('hidden');
            playlistsSection.classList.remove('hidden');
        });

        // Modal handling
        if (createPlaylistBtn) createPlaylistBtn.addEventListener('click', () => {
            createPlaylistModal.classList.remove('hidden');
        });

        if (cancelCreateBtn) cancelCreateBtn.addEventListener('click', () => {
            createPlaylistModal.classList.add('hidden');
            playlistNameInput.value = '';
        });

        if (addJobsToPlaylistBtn) addJobsToPlaylistBtn.addEventListener('click', () => {
            addJobsModal.classList.remove('hidden');
            loadAvailableJobs();
        });

        if (cancelAddJobsBtn) cancelAddJobsBtn.addEventListener('click', () => {
            addJobsModal.classList.add('hidden');
            selectedJobs.clear();
        });

        if (refreshJobsBtn) refreshJobsBtn.addEventListener('click', loadJobs);

        // Show/hide modals
        if (showUserSelectBtn) showUserSelectBtn.addEventListener('click', () => {
            userSelectModal.classList.remove('hidden');
            populateUserDropdown();
        });

        if (cancelUserSelectBtn) cancelUserSelectBtn.addEventListener('click', () => {
            userSelectModal.classList.add('hidden');
            userSelectForm.reset();
        });

        // Handle user selection
        if (userSelectForm) userSelectForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userDropdown = document.getElementById('userDropdown');
            const newUsernameInput = document.getElementById('newUsername');
            let username = userDropdown.value;
            if (username === '__new__') {
                username = newUsernameInput.value.trim();
                if (!username) {
                    alert('Please enter a username');
                    return;
                }
            }
            try {
                const response = await fetch(`${API_URL}/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username })
                });
                const data = await response.json();
                if (response.ok) {
                    currentUser = data;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    updateUserUI();
                    userSelectModal.classList.add('hidden');
                    userSelectForm.reset();
                    loadPlaylists();
                } else {
                    alert(data.error || 'Error selecting user');
                }
            } catch (error) {
                console.error('User selection error:', error);
                alert('Error selecting user');
            }
        });

        // Update user UI
        function updateUserUI() {
            if (currentUser) {
                userSection.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <span class="text-white">
                            <i class="fas fa-user mr-2"></i>${currentUser.username}
                        </span>
                        <button id="changeUser" class="px-4 py-2 bg-purple-600 rounded hover:bg-purple-700 transition-colors">
                            <i class="fas fa-exchange-alt mr-2"></i>Change
                        </button>
                    </div>
                `;
                document.getElementById('changeUser').addEventListener('click', () => {
                    userSelectModal.classList.remove('hidden');
                });
            } else {
                userSection.innerHTML = `
                    <button id="showUserSelect" class="px-4 py-2 bg-purple-600 rounded hover:bg-purple-700 transition-colors">
                        <i class="fas fa-user mr-2"></i>Select User
                    </button>
                `;
                document.getElementById('showUserSelect').addEventListener('click', () => {
                    userSelectModal.classList.remove('hidden');
                    populateUserDropdown();
                });
            }
        }

        // Load and display jobs
        async function loadJobs() {
            try {
                const response = await fetch(`${API_URL}/jobs`);
                const jobs = await response.json();
                const jobsList = document.getElementById('jobsList');
                
                jobsList.innerHTML = jobs.map(job => `
                    <div class="job-card bg-white p-4 rounded-lg shadow">
                        <h3 class="font-bold text-lg mb-2">${job.title}</h3>
                        <p class="text-gray-600 mb-2">by ${job.creator}</p>
                        <div class="text-sm text-gray-500">
                            <p><i class="fas fa-star mr-1"></i>Rating: ${job.rating || 'N/A'}</p>
                            <p><i class="fas fa-users mr-1"></i>Players: ${job.players || 'N/A'}</p>
                        </div>
                        <div class="mt-4 flex space-x-2">
                            <a href="${job.url}" target="_blank" 
                               class="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-center">
                                <i class="fas fa-external-link-alt mr-1"></i>View Job
                            </a>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading jobs:', error);
            }
        }

        // Load and display playlists
        async function loadPlaylists() {
            try {
                const response = await fetch(`${API_URL}/playlists`);
                const playlists = await response.json();
                console.log('Loaded playlists:', playlists); // Debug log
                const playlistsList = document.getElementById('playlistsList');
                
                playlistsList.innerHTML = playlists.map(playlist => `
                    <div class="minimal-card p-6 mb-6">
                        <h3 class="section-title text-xl mb-2">${playlist.name}</h3>
                        <p class="label mb-1"><i class="fas fa-list mr-1"></i>${playlist.jobs.length} jobs</p>
                        <p class="label mb-1"><i class="fas fa-calendar-plus mr-1"></i>Created: ${new Date(playlist.createdAt).toLocaleDateString()}</p>
                        <p class="label mb-3"><i class="fas fa-clock mr-1"></i>Updated: ${new Date(playlist.updatedAt).toLocaleDateString()}</p>
                        <button onclick="viewPlaylist('${playlist._id}')" class="btn w-full flex items-center justify-center"><i class="fas fa-eye mr-1"></i>View Playlist</button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading playlists:', error);
            }
        }

        // View playlist details
        window.viewPlaylist = async (playlistId) => {
            currentPlaylistId = playlistId;
            try {
                const response = await fetch(`${API_URL}/playlists/${playlistId}`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch playlist: ${response.status} ${response.statusText}`);
                }
                const playlist = await response.json();
                if (!playlist || !playlist.jobs) {
                    throw new Error('Playlist data is missing or invalid');
                }

                document.getElementById('playlistDetailsTitle').innerHTML = `
                    ${playlist.name}
                    <button onclick="openEditPlaylistModal('${playlist._id}', '${playlist.name}')" 
                            class="ml-2 px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm">
                        <i class="fas fa-edit"></i>
                    </button>
                `;
                document.getElementById('playlistStats').textContent = `${playlist.jobs.length} jobs`;
                document.getElementById('playlistDates').textContent = 
                    `Created: ${new Date(playlist.createdAt).toLocaleDateString()} | ` +
                    `Updated: ${new Date(playlist.updatedAt).toLocaleDateString()}`;
                
                const playlistJobs = document.getElementById('playlistJobs');
                playlistJobs.innerHTML = playlist.jobs.map(job => `
                    <div class="job-card minimal-card p-4 flex justify-between items-center mb-4">
                        <div>
                            <h4 class="font-bold section-title mb-1">${job.title}</h4>
                            <p class="label text-sm mb-1">by ${job.creator}</p>
                        </div>
                        <div class="flex space-x-2">
                            <a href="${job.url}" target="_blank" class="btn flex items-center"><i class="fas fa-external-link-alt mr-1"></i>View</a>
                            <button onclick="removeJobFromPlaylist('${playlistId}', '${job.url}')" class="btn bg-red-600 hover:bg-red-700"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `).join('');

                // Render stats table for all jobs and users
                renderStatsTable(playlist);

                currentPlaylistPlayers = playlist.players || [];

                playlistsSection.classList.add('hidden');
                playlistDetailsSection.classList.remove('hidden');
            } catch (error) {
                console.error('Error loading playlist details:', error);
                alert('Error loading playlist details: ' + error.message);
            }
        };

        // Fast stat entry table for playlist jobs and users
        function renderStatsTable(playlist) {
            fetch(`${API_URL}/users`).then(r => r.json()).then(users => {
                const jobs = playlist.jobs;
                const stats = playlist.stats || [];
                const pointsTable = [15,12,10,8,7,6,5,4,3,2,1,0];
                let html = `<div class="mt-6 mb-4 minimal-card p-2 shadow-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-lg flex items-center">
                            <i class="fas fa-trophy text-yellow-500 mr-2"></i>Player Stats
                        </h3>
                        <button id="saveAllStatsBtn" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-700 text-white font-bold rounded shadow text-xs ml-2"><i class="fas fa-save mr-1"></i>Save All</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">`;
                if (users.length === 0 || jobs.length === 0) {
                    html += `<div class="text-gray-500 italic mb-2 text-xs">No users or jobs available to enter stats.</div></div>`;
                    document.getElementById('playlistJobs').innerHTML = html;
                    return;
                }
                jobs.forEach(job => {
                    html += `<div class="minimal-card p-3 shadow flex flex-col">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-flag-checkered text-blue-700 mr-2"></i>
                            <span class="font-bold text-base">${job.title}</span>
                        </div>
                        <div class="space-y-2">
                    `;
                    (currentPlaylistPlayers || []).forEach((user, idx) => {
                        const stat = stats.find(s => s.username === user && s.jobUrl === job.url) || {};
                        let placement = stat.placement || '';
                        let isDNF = placement === 'DNF' || placement === 0;
                        const statNotes = stat.statNotes || '';
                        // Fastest/slowest lap dropdown
                        let fastestLap = stat.fastestLap;
                        let slowestLap = stat.slowestLap;
                        let lapDropdown = '';
                        if (fastestLap === true) lapDropdown = 'Fastest';
                        else if (slowestLap === true) lapDropdown = 'Slowest';
                        else lapDropdown = '';
                        // Points calculation
                        let points = '';
                        if (isDNF) {
                            points = 0;
                        } else if (placement && placement >= 1) {
                            points = pointsTable[placement-1] !== undefined ? pointsTable[placement-1] : 0;
                        }
                        // Placement options only up to number of players
                        const placementOptions = Array.from({length: (currentPlaylistPlayers || []).length}, (_,i) => `<option value="${i+1}"${placement==i+1?' selected':''}>${i+1}</option>`).join('');
                        html += `<div class="flex items-center space-x-2 text-xs">
                            <span class="w-20 font-semibold">${user}</span>
                            <select class="stat-input border rounded px-1 py-0.5 w-16 minimal-card" data-job="${job.url}" data-user="${user}" data-field="placement">
                                <option value=""></option>
                                ${placementOptions}
                                <option value="DNF"${isDNF?' selected':''}>DNF</option>
                            </select>
                            <span class="text-gray-400">P</span>
                            <select class="stat-input border rounded w-20 px-1 py-0.5 minimal-card" data-job="${job.url}" data-user="${user}" data-field="lapType">
                                <option value=""${lapDropdown===''?' selected':''}></option>
                                <option value="Fastest"${lapDropdown==='Fastest'?' selected':''}>Fastest</option>
                                <option value="Slowest"${lapDropdown==='Slowest'?' selected':''}>Slowest</option>
                            </select>
                            <span class="text-gray-400">F/L</span>
                            <input type="text" class="stat-input border rounded w-20 px-1 py-0.5 minimal-card" placeholder="Note" data-job="${job.url}" data-user="${user}" data-field="statNotes" value="${statNotes}">
                            <span class="ml-2 font-bold text-blue-600">${points}</span>
                        </div>`;
                    });
                    html += `</div></div>`;
                });
                html += `</div></div>`;
                document.getElementById('playlistJobs').innerHTML = html;

                // Save All button logic
                document.getElementById('saveAllStatsBtn').onclick = () => {
                    const stats = [];
                    (jobs || []).forEach(job => {
                        (currentPlaylistPlayers || []).forEach(user => {
                            let placement = document.querySelector(`.stat-input[data-job='${job.url}'][data-user='${user}'][data-field='placement']`).value;
                            if (placement === 'DNF') placement = 0;
                            // Fastest/slowest lap dropdown
                            let lapType = document.querySelector(`.stat-input[data-job='${job.url}'][data-user='${user}'][data-field='lapType']`).value;
                            let fastestLap = undefined, slowestLap = undefined;
                            if (lapType === 'Fastest') fastestLap = true;
                            if (lapType === 'Slowest') slowestLap = true;
                            const statNotes = document.querySelector(`.stat-input[data-job='${job.url}'][data-user='${user}'][data-field='statNotes']`).value;
                            stats.push({
                                username: user,
                                jobUrl: job.url,
                                placement: placement ? Number(placement) : undefined,
                                fastestLap,
                                slowestLap,
                                statNotes: statNotes || undefined
                            });
                        });
                    });
                    fetch(`${API_URL}/playlists/${playlist._id}/stats/bulk`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ stats })
                    }).then(r => r.json()).then(data => {
                        const btn = document.getElementById('saveAllStatsBtn');
                        btn.textContent = 'Saved!';
                        setTimeout(()=>{ btn.innerHTML = '<i class="fas fa-save mr-1"></i>Save All'; }, 1200);
                        viewPlaylist(playlist._id); // Refresh
                    }).catch(e => alert('Error saving stats: ' + e.message));
                };
            });
        }

        // User removal function
        window.deleteUser = function(username) {
            if (!confirm(`Delete user ${username}?`)) return;
            fetch(`${API_URL}/users/${encodeURIComponent(username)}`, { method: 'DELETE' })
                .then(r => r.json())
                .then(data => {
                    alert('User deleted');
                    populateUserDropdown(); // Refresh user list
                })
                .catch(e => alert('Error deleting user: ' + e.message));
        };

        // Remove job from playlist
        window.removeJobFromPlaylist = async (playlistId, jobUrl) => {
            if (!confirm('Are you sure you want to remove this job from the playlist?')) return;
            
            try {
                const response = await fetch(`${API_URL}/playlists/${playlistId}/jobs/${encodeURIComponent(jobUrl)}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    viewPlaylist(playlistId);
                }
            } catch (error) {
                console.error('Error removing job from playlist:', error);
            }
        };

        // Load available jobs for adding to playlist
        async function loadAvailableJobs() {
            try {
                console.log('Loading available jobs...');
                const response = await fetch(`${API_URL}/jobs`);
                const jobs = await response.json();
                console.log('Loaded jobs:', jobs);
                
                const availableJobs = document.getElementById('availableJobs');
                if (!availableJobs) {
                    console.error('Could not find availableJobs element');
                    return;
                }
                
                if (jobs.length === 0) {
                    availableJobs.innerHTML = '<p class="text-gray-500">No jobs available to add</p>';
                    return;
                }
                
                availableJobs.innerHTML = jobs.map(job => `
                    <div class="minimal-card flex items-center p-3 shadow rounded mb-2">
                        <input type="checkbox" class="mr-3 h-5 w-5 text-blue-600 rounded focus:ring-blue-500" onchange="toggleJobSelection(this, ${JSON.stringify(job).replace(/\"/g, '&quot;')})">
                        <div class="flex-1">
                            <h4 class="font-bold section-title">${job.title}</h4>
                            <p class="label text-sm">by ${job.creator}</p>
                        </div>
                    </div>
                `).join('');
                
                console.log('Rendered job list');
            } catch (error) {
                console.error('Error loading available jobs:', error);
                alert('Error loading jobs: ' + error.message);
            }
        }

        // Toggle job selection
        window.toggleJobSelection = (checkbox, job) => {
            console.log('Toggling job:', job);
            console.log('Checkbox checked:', checkbox.checked);
            
            if (checkbox.checked) {
                selectedJobs.set(job.url, job);
            } else {
                selectedJobs.delete(job.url);
            }
            
            console.log('Current selected jobs:', Array.from(selectedJobs.values()));
            console.log('Number of selected jobs:', selectedJobs.size);
        };

        // Add selected jobs to playlist
        confirmAddJobsBtn.addEventListener('click', async () => {
            console.log('Add jobs button clicked');
            console.log('Selected jobs size:', selectedJobs.size);
            console.log('Selected jobs:', Array.from(selectedJobs.values()));
            
            if (selectedJobs.size === 0) {
                alert('Please select at least one job to add');
                return;
            }
            
            const jobsToAdd = Array.from(selectedJobs.values());
            console.log('Adding jobs:', jobsToAdd);
            
            try {
                const response = await fetch(`${API_URL}/playlists/${currentPlaylistId}/jobs`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ jobs: jobsToAdd })
                });
                
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                
                if (response.ok) {
                    addJobsModal.classList.add('hidden');
                    selectedJobs.clear();
                    viewPlaylist(currentPlaylistId);
                } else {
                    alert('Error adding jobs: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error adding jobs to playlist:', error);
                alert('Error adding jobs: ' + error.message);
            }
        });

        // Create new playlist
        confirmCreateBtn.addEventListener('click', async () => {
            const name = playlistNameInput.value.trim();
            if (!name) return;

            try {
                const response = await fetch(`${API_URL}/playlists`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        name
                    })
                });
                const data = await response.json();
                console.log('Playlist creation response:', data); // Debug log
                if (response.ok) {
                    createPlaylistModal.classList.add('hidden');
                    playlistNameInput.value = '';
                    loadPlaylists();
                } else {
                    alert('Error creating playlist: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error creating playlist:', error);
                alert('Error creating playlist: ' + error.message);
            }
        });

        // Edit playlist functionality
        window.openEditPlaylistModal = (playlistId, currentName) => {
            currentPlaylistId = playlistId;
            editPlaylistNameInput.value = currentName;
            editPlaylistModal.classList.remove('hidden');
        };

        cancelEditBtn.addEventListener('click', () => {
            editPlaylistModal.classList.add('hidden');
            editPlaylistNameInput.value = '';
        });

        confirmEditBtn.addEventListener('click', async () => {
            const newName = editPlaylistNameInput.value.trim();
            if (!newName) return;

            try {
                const response = await fetch(`${API_URL}/playlists/${currentPlaylistId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: newName })
                });

                if (response.ok) {
                    editPlaylistModal.classList.add('hidden');
                    editPlaylistNameInput.value = '';
                    viewPlaylist(currentPlaylistId);
                    loadPlaylists(); // Refresh the playlists list
                } else {
                    const data = await response.json();
                    alert('Error updating playlist: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating playlist:', error);
                alert('Error updating playlist: ' + error.message);
            }
        });

        // Drag and drop functionality
        let draggedItem = null;

        window.handleDragStart = (e) => {
            draggedItem = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', e.target.dataset.index);
        };

        window.handleDragOver = (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        };

        window.handleDrop = async (e) => {
            e.preventDefault();
            const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
            const toIndex = parseInt(e.target.closest('.draggable-job').dataset.index);
            
            if (fromIndex === toIndex) return;

            try {
                const response = await fetch(`${API_URL}/playlists/${currentPlaylistId}/reorder`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ fromIndex, toIndex })
                });

                if (response.ok) {
                    viewPlaylist(currentPlaylistId);
                } else {
                    const data = await response.json();
                    alert('Error reordering jobs: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error reordering jobs:', error);
                alert('Error reordering jobs: ' + error.message);
            }
        };

        window.handleDragEnd = (e) => {
            e.target.classList.remove('dragging');
            draggedItem = null;
        };

        // Populate user dropdown and handle new user option
        async function populateUserDropdown() {
            const userDropdown = document.getElementById('userDropdown');
            const newUserSection = document.getElementById('newUserSection');
            const newUsernameInput = document.getElementById('newUsername');
            userDropdown.innerHTML = '<option value="">Loading...</option>';
            let users = [];
            try {
                const response = await fetch(`${API_URL}/users`);
                users = await response.json();
            } catch (error) {
                // Ignore error, will handle below
            }
            userDropdown.innerHTML = '';
            let hasUsers = false;
            if (Array.isArray(users) && users.length > 0) {
                users.forEach(user => {
                    hasUsers = true;
                    const option = document.createElement('option');
                    option.value = user.username;
                    option.textContent = user.username;
                    userDropdown.appendChild(option);
                });
            }
            // Always add the 'Add new user...' option
            const newOption = document.createElement('option');
            newOption.value = '__new__';
            newOption.textContent = 'Add new user...';
            userDropdown.appendChild(newOption);

            // If no users, select 'Add new user...' and show input
            if (!hasUsers) {
                userDropdown.value = '__new__';
                newUserSection.classList.remove('hidden');
            } else {
                newUserSection.classList.add('hidden');
            }
            userDropdown.addEventListener('change', () => {
                if (userDropdown.value === '__new__') {
                    newUserSection.classList.remove('hidden');
                    newUsernameInput.value = '';
                } else {
                    newUserSection.classList.add('hidden');
                    newUsernameInput.value = '';
                }
            });
        }

        // Manage Players modal logic
        if (managePlayersBtn) managePlayersBtn.addEventListener('click', async () => {
            // Fetch all users
            const users = await fetch(`${API_URL}/users`).then(r => r.json());
            // Show checkboxes for all users
            playersCheckboxList.innerHTML = users.map(user => `
                <label class="flex items-center space-x-2 label">
                    <input type="checkbox" value="${user.username}" ${currentPlaylistPlayers.includes(user.username) ? 'checked' : ''}>
                    <span>${user.username}</span>
                </label>
            `).join('');
            managePlayersModal.classList.remove('hidden');
        });
        if (cancelManagePlayersBtn) cancelManagePlayersBtn.addEventListener('click', () => {
            managePlayersModal.classList.add('hidden');
        });
        if (saveManagePlayersBtn) saveManagePlayersBtn.addEventListener('click', async () => {
            const checked = Array.from(playersCheckboxList.querySelectorAll('input[type=checkbox]:checked')).map(cb => cb.value);
            await fetch(`${API_URL}/playlists/${currentPlaylistId}/players`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ players: checked })
            });
            currentPlaylistPlayers = checked;
            managePlayersModal.classList.add('hidden');
            viewPlaylist(currentPlaylistId);
        });

        // Initial state check
        checkSavedState();

        // On initial load, set the default active button:
        setActiveNav('jobs');
    });
    </script>
</body>
</html> 